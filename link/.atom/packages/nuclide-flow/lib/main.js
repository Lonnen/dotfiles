var _nuclideAnalytics = require('nuclide-analytics');

var _constantsJs = require('./constants.js');

'use babel';

/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

var invariant = require('assert');

var _require = require('atom');

var CompositeDisposable = _require.CompositeDisposable;

var GRAMMARS_STRING = _constantsJs.JS_GRAMMARS.join(', ');
var diagnosticsOnFlySetting = 'nuclide-flow.diagnosticsOnFly';

var PACKAGE_NAME = 'nuclide-flow';

function getServiceByNuclideUri(service, file) {
  return require('nuclide-client').getServiceByNuclideUri(service, file);
}

var busySignalProvider = undefined;

var flowDiagnosticsProvider = undefined;

var disposables = undefined;

module.exports = {

  // $FlowIssue https://github.com/facebook/flow/issues/620
  config: require('../package.json').nuclide.config,

  activate: function activate() {
    if (!disposables) {
      disposables = new CompositeDisposable();

      var _require2 = require('nuclide-atom-helpers');

      var registerGrammarForFileExtension = _require2.registerGrammarForFileExtension;

      disposables.add(registerGrammarForFileExtension('source.ini', '.flowconfig'));
    }
  },

  /** Provider for autocomplete service. */
  createAutocompleteProvider: function createAutocompleteProvider() {
    var AutocompleteProvider = require('./FlowAutocompleteProvider');
    var autocompleteProvider = new AutocompleteProvider();
    var getSuggestions = autocompleteProvider.getSuggestions.bind(autocompleteProvider);
    return {
      selector: _constantsJs.JS_GRAMMARS.map(function (grammar) {
        return '.' + grammar;
      }).join(', '),
      disableForSelector: '.source.js .comment',
      inclusionPriority: 1,
      // We want to get ranked higher than the snippets provider.
      suggestionPriority: 5,
      onDidInsertSuggestion: function onDidInsertSuggestion() {
        (0, _nuclideAnalytics.track)('nuclide-flow.autocomplete-chosen');
      },
      getSuggestions: getSuggestions
    };
  },

  getHyperclickProvider: function getHyperclickProvider() {
    var FlowHyperclickProvider = require('./FlowHyperclickProvider');
    var flowHyperclickProvider = new FlowHyperclickProvider();
    var getSuggestionForWord = flowHyperclickProvider.getSuggestionForWord.bind(flowHyperclickProvider);
    return {
      wordRegExp: _constantsJs.JAVASCRIPT_WORD_REGEX,
      priority: 20,
      providerName: PACKAGE_NAME,
      getSuggestionForWord: getSuggestionForWord
    };
  },

  provideBusySignal: function provideBusySignal() {
    if (!busySignalProvider) {
      var _require3 = require('nuclide-busy-signal-provider-base');

      var _BusySignalProviderBase = _require3.BusySignalProviderBase;

      busySignalProvider = new _BusySignalProviderBase();
    }
    return busySignalProvider;
  },

  provideDiagnostics: function provideDiagnostics() {
    if (!flowDiagnosticsProvider) {
      var busyProvider = this.provideBusySignal();
      var FlowDiagnosticsProvider = require('./FlowDiagnosticsProvider');
      var runOnTheFly = atom.config.get(diagnosticsOnFlySetting);
      flowDiagnosticsProvider = new FlowDiagnosticsProvider(runOnTheFly, busyProvider);
      invariant(disposables);
      disposables.add(atom.config.observe(diagnosticsOnFlySetting, function (newValue) {
        invariant(flowDiagnosticsProvider);
        flowDiagnosticsProvider.setRunOnTheFly(newValue);
      }));

      var _require4 = require('nuclide-atom-helpers');

      var projects = _require4.projects;

      disposables.add(projects.onDidRemoveProjectPath(function (projectPath) {
        invariant(flowDiagnosticsProvider);
        flowDiagnosticsProvider.invalidateProjectPath(projectPath);
      }));
    }
    return flowDiagnosticsProvider;
  },

  createTypeHintProvider: function createTypeHintProvider() {
    var _require5 = require('./FlowTypeHintProvider');

    var FlowTypeHintProvider = _require5.FlowTypeHintProvider;

    var flowTypeHintProvider = new FlowTypeHintProvider();
    var typeHint = flowTypeHintProvider.typeHint.bind(flowTypeHintProvider);
    return {
      selector: GRAMMARS_STRING,
      providerName: PACKAGE_NAME,
      inclusionPriority: 1,
      typeHint: typeHint
    };
  },

  deactivate: function deactivate() {
    // TODO(mbolin): Find a way to unregister the autocomplete provider from
    // ServiceHub, or set a boolean in the autocomplete provider to always return
    // empty results.
    getServiceByNuclideUri('FlowService').dispose();
    if (disposables) {
      disposables.dispose();
      disposables = null;
    }
    if (flowDiagnosticsProvider) {
      flowDiagnosticsProvider.dispose();
      flowDiagnosticsProvider = null;
    }
  }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBwZmw1Mm5wdWJsaXNoX3BhY2thZ2VzL2FwbS9udWNsaWRlLWZsb3cvbGliL21haW4uanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6ImdDQWVvQixtQkFBbUI7OzJCQUVVLGdCQUFnQjs7QUFqQmpFLFdBQVcsQ0FBQzs7Ozs7Ozs7OztBQVdaLElBQU0sU0FBUyxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQzs7ZUFFTixPQUFPLENBQUMsTUFBTSxDQUFDOztJQUF0QyxtQkFBbUIsWUFBbkIsbUJBQW1COztBQUsxQixJQUFNLGVBQWUsR0FBRyxhQURoQixXQUFXLENBQ2lCLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUMvQyxJQUFNLHVCQUF1QixHQUFHLCtCQUErQixDQUFDOztBQUVoRSxJQUFNLFlBQVksR0FBRyxjQUFjLENBQUM7O0FBRXBDLFNBQVMsc0JBQXNCLENBQUMsT0FBTyxFQUFFLElBQUssRUFBRTtBQUM5QyxTQUFPLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLHNCQUFzQixDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQztDQUN4RTs7QUFFRCxJQUFJLGtCQUFrQixZQUFBLENBQUM7O0FBRXZCLElBQUksdUJBQXVCLFlBQUEsQ0FBQzs7QUFFNUIsSUFBSSxXQUFXLFlBQUEsQ0FBQzs7QUFFaEIsTUFBTSxDQUFDLE9BQU8sR0FBRzs7O0FBR2YsUUFBTSxFQUFFLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxNQUFNOztBQUVqRCxVQUFRLEVBQUEsb0JBQUc7QUFDVCxRQUFJLENBQUMsV0FBVyxFQUFFO0FBQ2hCLGlCQUFXLEdBQUcsSUFBSSxtQkFBbUIsRUFBRSxDQUFDOztzQkFFRSxPQUFPLENBQUMsc0JBQXNCLENBQUM7O1VBQWxFLCtCQUErQixhQUEvQiwrQkFBK0I7O0FBQ3RDLGlCQUFXLENBQUMsR0FBRyxD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QkFBc0IsRUFBQSxrQ0FBVztvQkFDQSxPQUFPLENBQUMsd0JBQXdCLENBQUM7O1FBQXpELG9CQUFvQixhQUFwQixvQkFBb0I7O0FBQzNCLFFBQU0sb0JBQW9CLEdBQUcsSUFBSSxvQkFBb0IsRUFBRSxDQUFDO0FBQ3hELFFBQU0sUUFBUSxHQUFHLG9CQUFvQixDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsQ0FBQztBQUMxRSxXQUFPO0FBQ0wsY0FBUSxFQUFFLGVBQWU7QUFDekIsa0JBQVksRUFBRSxZQUFZO0FBQzFCLHVCQUFpQixFQUFFLENBQUM7QUFDcEIsY0FBUSxFQUFSLFFBQVE7S0FDVCxDQUFDO0dBQ0g7O0FBRUQsWUFBVSxFQUFBLHNCQUFHOzs7O0FBSVgsMEJBQXNCLENBQUMsYUFBYSxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7QUFDaEQsUUFBSSxXQUFXLEVBQUU7QUFDZixpQkFBVyxDQUFDLE9BQU8sRUFBRSxDQUFDO0FBQ3RCLGlCQUFXLEdBQUcsSUFBSSxDQUFDO0tBQ3BCO0FBQ0QsUUFBSSx1QkFBdUIsRUFBRTtBQUMzQiw2QkFBdUIsQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUNsQyw2QkFBdUIsR0FBRyxJQUFJLENBQUM7S0FDaEM7R0FDRjtDQUNGLENBQUMiLCJmaWxlIjoiL3Zhci9mb2xkZXJzL3hmL3JzcGg0X2M1NzMxNXJzNTd4eHNkc2tyeG52MzZ0MC9UL3RtcHBmbDUybnB1Ymxpc2hfcGFja2FnZXMvYXBtL251Y2xpZGUtZmxvdy9saWIvbWFpbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2UgYmFiZWwnO1xuLyogQGZsb3cgKi9cblxuLypcbiAqIENvcHlyaWdodCAoYykgMjAxNS1wcmVzZW50LCBGYWNlYm9vaywgSW5jLlxuICogQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBsaWNlbnNlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgaW5cbiAqIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICovXG5cbmNvbnN0IGludmFyaWFudCA9IHJlcXVpcmUoJ2Fzc2VydCcpO1xuXG5jb25zdCB7Q29tcG9zaXRlRGlzcG9zYWJsZX0gPSByZXF1aXJlKCdhdG9tJyk7XG5cbmltcG9ydCB7dHJhY2t9IGZyb20gJ251Y2xpZGUtYW5hbHl0aWNzJztcblxuaW1wb3J0IHtKU19HUkFNTUFSUywgSkFWQVNDUklQVF9XT1JEX1JFR0VYfSBmcm9tICcuL2NvbnN0YW50cy5qcyc7XG5jb25zdCBHUkFNTUFSU19TVFJJTkcgPSBKU19HUkFNTUFSUy5qb2luKCcsICcpO1xuY29uc3QgZGlhZ25vc3RpY3NPbkZseVNldHRpbmcgPSAnbnVjbGlkZS1mbG93LmRpYWdub3N0aWNzT25GbHknO1xuXG5jb25zdCBQQUNLQUdFX05BTUUgPSAnbnVjbGlkZS1mbG93JztcblxuZnVuY3Rpb24gZ2V0U2VydmljZUJ5TnVjbGlkZVVyaShzZXJ2aWNlLCBmaWxlPykge1xuICByZXR1cm4gcmVxdWlyZSgnbnVjbGlkZS1jbGllbnQnKS5nZXRTZXJ2aWNlQnlOdWNsaWRlVXJpKHNlcnZpY2UsIGZpbGUpO1xufVxuXG5sZXQgYnVzeVNpZ25hbFByb3ZpZGVyO1xuXG5sZXQgZmxvd0RpYWdub3N0aWNzUHJvdmlkZXI7XG5cbmxldCBkaXNwb3NhYmxlcztcblxubW9kdWxlLmV4cG9ydHMgPSB7XG5cbiAgLy8gJEZsb3dJc3N1ZSBodHRwczovL2dpdGh1Yi5jb20vZmFjZWJvb2svZmxvdy9pc3N1ZXMvNjIwXG4gIGNvbmZpZzogcmVxdWlyZSgnLi4vcGFja2FnZS5qc29uJykubnVjbGlkZS5jb25maWcsXG5cbiAgYWN0aXZhdGUoKSB7XG4gICAgaWYgKCFkaXNwb3NhYmxlcykge1xuICAgICAgZGlzcG9zYWJsZXMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpO1xuXG4gICAgICBjb25zdCB7cmVnaXN0ZXJHcmFtbWFyRm9yRmlsZUV4dGVuc2lvbn0gPSByZXF1aXJlKCdudWNsaWRlLWF0b20taGVscGVycycpO1xuICAgICAgZGlzcG9zYWJsZXMuYWRkKHJlZ2lzdGVyR3JhbW1hckZvckZpbGVFeHRlbnNpb24oJ3NvdXJjZS5pbmknLCAnLmZsb3djb25maWcnKSk7XG4gICAgfVxuICB9LFxuXG4gIC8qKiBQcm92aWRlciBmb3IgYXV0b2NvbXBsZXRlIHNlcnZpY2UuICovXG4gIGNyZWF0ZUF1dG9jb21wbGV0ZVByb3ZpZGVyKCk6IGF0b20kQXV0b2NvbXBsZXRlUHJvdmlkZXIge1xuICAgIGNvbnN0IEF1dG9jb21wbGV0ZVByb3ZpZGVyID0gcmVxdWlyZSgnLi9GbG93QXV0b2NvbXBsZXRlUHJvdmlkZXInKTtcbiAgICBjb25zdCBhdXRvY29tcGxldGVQcm92aWRlciA9IG5ldyBBdXRvY29tcGxldGVQcm92aWRlcigpO1xuICAgIGNvbnN0IGdldFN1Z2dlc3Rpb25zID0gYXV0b2NvbXBsZXRlUHJvdmlkZXIuZ2V0U3VnZ2VzdGlvbnMuYmluZChhdXRvY29tcGxldGVQcm92aWRlcik7XG4gICAgcmV0dXJuIHtcbiAgICAgIHNlbGVjdG9yOiBKU19HUkFNTUFSUy5tYXAoZ3JhbW1hciA9PiAnLicgKyBncmFtbWFyKS5qb2luKCcsICcpLFxuICAgICAgZGlzYWJsZUZvclNlbGVjdG9yOiAnLnNvdXJjZS5qcyAuY29tbWVudCcsXG4gICAgICBpbmNsdXNpb25Qcmlvcml0eTogMSxcbiAgICAgIC8vIFdlIHdhbnQgdG8gZ2V0IHJhbmtlZCBoaWdoZXIgdGhhbiB0aGUgc25pcHBldHMgcHJvdmlkZXIuXG4gICAgICBzdWdnZXN0aW9uUHJpb3JpdHk6IDUsXG4gICAgICBvbkRpZEluc2VydFN1Z2dlc3Rpb246ICgpID0+IHtcbiAgICAgICAgdHJhY2soJ251Y2xpZGUtZmxvdy5hdXRvY29tcGxldGUtY2hvc2VuJyk7XG4gICAgICB9LFxuICAgICAgZ2V0U3VnZ2VzdGlvbnMsXG4gICAgfTtcbiAgfSxcblxuICBnZXRIeXBlcmNsaWNrUHJvdmlkZXIoKTogSHlwZXJjbGlja1Byb3ZpZGVyIHtcbiAgICBjb25zdCBGbG93SHlwZXJjbGlja1Byb3ZpZGVyID0gcmVxdWlyZSgnLi9GbG93SHlwZXJjbGlja1Byb3ZpZGVyJyk7XG4gICAgY29uc3QgZmxvd0h5cGVyY2xpY2tQcm92aWRlciA9IG5ldyBGbG93SHlwZXJjbGlja1Byb3ZpZGVyKCk7XG4gICAgY29uc3QgZ2V0U3VnZ2VzdGlvbkZvcldvcmQgPVxuICAgICAgICBmbG93SHlwZXJjbGlja1Byb3ZpZGVyLmdldFN1Z2dlc3Rpb25Gb3JXb3JkLmJpbmQoZmxvd0h5cGVyY2xpY2tQcm92aWRlcik7XG4gICAgcmV0dXJuIHtcbiAgICAgIHdvcmRSZWdFeHA6IEpBVkFTQ1JJUFRfV09SRF9SRUdFWCxcbiAgICAgIHByaW9yaXR5OiAyMCxcbiAgICAgIHByb3ZpZGVyTmFtZTogUEFDS0FHRV9OQU1FLFxuICAgICAgZ2V0U3VnZ2VzdGlvbkZvcldvcmQsXG4gICAgfTtcbiAgfSxcblxuICBwcm92aWRlQnVzeVNpZ25hbCgpOiBCdXN5U2lnbmFsUHJvdmlkZXJCYXNlIHtcbiAgICBpZiAoIWJ1c3lTaWduYWxQcm92aWRlcikge1xuICAgICAgY29uc3Qge0J1c3lTaWduYWxQcm92aWRlckJhc2V9ID0gcmVxdWlyZSgnbnVjbGlkZS1idXN5LXNpZ25hbC1wcm92aWRlci1iYXNlJyk7XG4gICAgICBidXN5U2lnbmFsUHJvdmlkZXIgPSBuZXcgQnVzeVNpZ25hbFByb3ZpZGVyQmFzZSgpO1xuICAgIH1cbiAgICByZXR1cm4gYnVzeVNpZ25hbFByb3ZpZGVyO1xuICB9LFxuXG4gIHByb3ZpZGVEaWFnbm9zdGljcygpIHtcbiAgICBpZiAoIWZsb3dEaWFnbm9zdGljc1Byb3ZpZGVyKSB7XG4gICAgICBjb25zdCBidXN5UHJvdmlkZXIgPSB0aGlzLnByb3ZpZGVCdXN5U2lnbmFsKCk7XG4gICAgICBjb25zdCBGbG93RGlhZ25vc3RpY3NQcm92aWRlciA9IHJlcXVpcmUoJy4vRmxvd0RpYWdub3N0aWNzUHJvdmlkZXInKTtcbiAgICAgIGNvbnN0IHJ1bk9uVGhlRmx5ID0gKChhdG9tLmNvbmZpZy5nZXQoZGlhZ25vc3RpY3NPbkZseVNldHRpbmcpOiBhbnkpOiBib29sZWFuKTtcbiAgICAgIGZsb3dEaWFnbm9zdGljc1Byb3ZpZGVyID0gbmV3IEZsb3dEaWFnbm9zdGljc1Byb3ZpZGVyKHJ1bk9uVGhlRmx5LCBidXN5UHJvdmlkZXIpO1xuICAgICAgaW52YXJpYW50KGRpc3Bvc2FibGVzKTtcbiAgICAgIGRpc3Bvc2FibGVzLmFkZChhdG9tLmNvbmZpZy5vYnNlcnZlKGRpYWdub3N0aWNzT25GbHlTZXR0aW5nLCBuZXdWYWx1ZSA9PiB7XG4gICAgICAgIGludmFyaWFudChmbG93RGlhZ25vc3RpY3NQcm92aWRlcik7XG4gICAgICAgIGZsb3dEaWFnbm9zdGljc1Byb3ZpZGVyLnNldFJ1bk9uVGhlRmx5KG5ld1ZhbHVlKTtcbiAgICAgIH0pKTtcbiAgICAgIGNvbnN0IHtwcm9qZWN0c30gPSByZXF1aXJlKCdudWNsaWRlLWF0b20taGVscGVycycpO1xuICAgICAgZGlzcG9zYWJsZXMuYWRkKHByb2plY3RzLm9uRGlkUmVtb3ZlUHJvamVjdFBhdGgocHJvamVjdFBhdGggPT4ge1xuICAgICAgICBpbnZhcmlhbnQoZmxvd0RpYWdub3N0aWNzUHJvdmlkZXIpO1xuICAgICAgICBmbG93RGlhZ25vc3RpY3NQcm92aWRlci5pbnZhbGlkYXRlUHJvamVjdFBhdGgocHJvamVjdFBhdGgpO1xuICAgICAgfSkpO1xuICAgIH1cbiAgICByZXR1cm4gZmxvd0RpYWdub3N0aWNzUHJvdmlkZXI7XG4gIH0sXG5cbiAgY3JlYXRlVHlwZUhpbnRQcm92aWRlcigpOiBPYmplY3Qge1xuICAgIGNvbnN0IHtGbG93VHlwZUhpbnRQcm92aWRlcn0gPSByZXF1aXJlKCcuL0Zsb3dUeXBlSGludFByb3ZpZGVyJyk7XG4gICAgY29uc3QgZmxvd1R5cGVIaW50UHJvdmlkZXIgPSBuZXcgRmxvd1R5cGVIaW50UHJvdmlkZXIoKTtcbiAgICBjb25zdCB0eXBlSGludCA9IGZsb3dUeXBlSGludFByb3ZpZGVyLnR5cGVIaW50LmJpbmQoZmxvd1R5cGVIaW50UHJvdmlkZXIpO1xuICAgIHJldHVybiB7XG4gICAgICBzZWxlY3RvcjogR1JBTU1BUlNfU1RSSU5HLFxuICAgICAgcHJvdmlkZXJOYW1lOiBQQUNLQUdFX05BTUUsXG4gICAgICBpbmNsdXNpb25Qcmlvcml0eTogMSxcbiAgICAgIHR5cGVIaW50LFxuICAgIH07XG4gIH0sXG5cbiAgZGVhY3RpdmF0ZSgpIHtcbiAgICAvLyBUT0RPKG1ib2xpbik6IEZpbmQgYSB3YXkgdG8gdW5yZWdpc3RlciB0aGUgYXV0b2NvbXBsZXRlIHByb3ZpZGVyIGZyb21cbiAgICAvLyBTZXJ2aWNlSHViLCBvciBzZXQgYSBib29sZWFuIGluIHRoZSBhdXRvY29tcGxldGUgcHJvdmlkZXIgdG8gYWx3YXlzIHJldHVyblxuICAgIC8vIGVtcHR5IHJlc3VsdHMuXG4gICAgZ2V0U2VydmljZUJ5TnVjbGlkZVVyaSgnRmxvd1NlcnZpY2UnKS5kaXNwb3NlKCk7XG4gICAgaWYgKGRpc3Bvc2FibGVzKSB7XG4gICAgICBkaXNwb3NhYmxlcy5kaXNwb3NlKCk7XG4gICAgICBkaXNwb3NhYmxlcyA9IG51bGw7XG4gICAgfVxuICAgIGlmIChmbG93RGlhZ25vc3RpY3NQcm92aWRlcikge1xuICAgICAgZmxvd0RpYWdub3N0aWNzUHJvdmlkZXIuZGlzcG9zZSgpO1xuICAgICAgZmxvd0RpYWdub3N0aWNzUHJvdmlkZXIgPSBudWxsO1xuICAgIH1cbiAgfSxcbn07XG4iXX0=
