var _createClass = (function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ('value' in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; })();

/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError('Cannot call a class as a function'); } }

'use babel';

var UPDATE_EVENT = 'update';
var INVALIDATE_EVENT = 'invalidate';

var _require = require('atom');

var CompositeDisposable = _require.CompositeDisposable;
var Emitter = _require.Emitter;

function getTextEventDispatcher() {
  return require('nuclide-text-event-dispatcher').getInstance();
}

var DiagnosticsProviderBase = (function () {
  function DiagnosticsProviderBase(options) {
    var textEventDispatcher = arguments.length <= 1 || arguments[1] === undefined ? getTextEventDispatcher() : arguments[1];

    _classCallCheck(this, DiagnosticsProviderBase);

    this._textEventDispatcher = textEventDispatcher;
    this._emitter = new Emitter();
    this._disposables = new CompositeDisposable();

    this._textEventCallback = callbackOrNoop(options.onTextEditorEvent);
    this._newUpdateSubscriberCallback = callbackOrNoop(options.onNewUpdateSubscriber);
    this._newInvalidateSubscriberCallback = callbackOrNoop(options.onNewInvalidateSubscriber);

    // The Set constructor creates an empty Set if passed null or undefined.
    this._grammarScopes = new Set(options.grammarScopes);
    this._allGrammarScopes = !!options.enableForAllGrammars;
    this._subscribeToTextEditorEvent(!!options.shouldRunOnTheFly);
  }

  /**
   * Subscribes to the appropriate event depending on whether we should run on
   * the fly or not.
   */

  _createClass(DiagnosticsProviderBase, [{
    key: '_subscribeToTextEditorEvent',
    value: function _subscribeToTextEditorEvent(shouldRunOnTheFly) {
      this._disposeEventSubscription();
      var dispatcher = this._textEventDispatcher;
      var subscription = undefined;
      if (shouldRunOnTheFly) {
        if (this._allGrammarScopes) {
          subscription = dispatcher.onAnyFileChange(this._textEventCallback);
        } else {
          subscription = dispatcher.onFileChange(this._grammarScopes, this._textEventCallback);
        }
      } else {
        if (this._allGrammarScopes) {
          subscription = dispatcher.onAnyFileSave(this._textEventCallback);
        } else {
          subscription = dispatcher.onFileSave(this._grammarScopes, this._textEventCallback);
        }
      }
      this._currentEventSubscription = subscription;
    }
  }, {
    key: 'setRunOnTheFly',
    value: function setRunOnTheFly(runOnTheFly) {
      this._subscribeToTextEditorEvent(runOnTheFly);
    }
  }, {
    key: 'dispose',
    value: function dispose() {
      this._emitter.dispose();
      this._disposables.dispose();
      this._disposeEventSubscription();
    }
  }, {
    key: '_disposeEventSubscription',
    value: function _disposeEventSubscription() {
      if (this._currentEventSubscription) {
        this._currentEventSubscription.dispose();
        this._currentEventSubscription = null;
      }
    }

    /**
     * Clients can call these methods to publish messages
     */

  }, {
    key: 'publishMessageUpdate',
    value: function publishMessageUpdate(update) {
      this._emitter.emit(UPDATE_EVENT, update);
    }
  }, {
    key: 'publishMessageInvalidation',
    value: function publishMessageInvalidation(message) {
      this._emitter.emit(INVALIDATE_EVENT, message);
    }

    /**
     * Clients should delegate to these
     */

  }, {
    key: 'onMessageUpdate',
    value: function onMessageUpdate(callback) {
      var disposable = this._emitter.on(UPDATE_EVENT, callback);
      this._newUpdateSubscriberCallback(callback);
      return disposable;
    }
  }, {
    key: 'onMessageInvalidation',
    value: function onMessageInvalidation(callback) {
      var disposable = this._emitter.on(INVALIDATE_EVENT, callback);
      this._newInvalidateSubscriberCallback(callback);
      return disposable;
    }
  }]);

  return DiagnosticsProviderBase;
})();

function callbackOrNoop(callback) {
  return callback ? callback.bind(undefined) : function () {};
}

module.exports = DiagnosticsProviderBase;

/** The callback by which a provider is notified of text events, such as a file save. */

/**
 * The callback by which a provider is notified that a new consumer has subscribed to diagnostic
 * updates.
 */

/**
 * The callback by which a provider is notified that a new consumer has subscribed to diagnostic
 * invalidations.
 */

/**
 * If true, this will cause onTextEditorEvent to get called more often -- approximately whenever
 * the user stops typing. If false, it will get called only when the user saves.
 */

/**
 * The following two options specify which grammars the provider is interested in. Most providers
 * will include a set of grammarScopes, and will therefore get notifications only about
 * TextEditors that are associated with those grammarScopes. Instead, a provider may set
 * enableForAllGrammars to true, and then it will get notified of changes in all TextEditors. If
 * enableForAllGrammars is true, it overrides the grammars in grammarScopes.
 */

// callbacks provided by client
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBwZmw1Mm5wdWJsaXNoX3BhY2thZ2VzL25wbS9udWNsaWRlLWRpYWdub3N0aWNzLXByb3ZpZGVyLWJhc2UvbGliL0RpYWdub3N0aWNzUHJvdmlkZXJCYXNlLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztBQUFBLFdBQVcsQ0FBQzs7QUFnRFosSUFBTSxZQUFZLEdBQUcsUUFBUSxDQUFDO0FBQzlCLElBQU0sZ0JBQWdCLEdBQUcsWUFBWSxDQUFDOztlQUVDLE9BQU8sQ0FBQyxNQUFNLENBQUM7O0lBQS9DLG1CQUFtQixZQUFuQixtQkFBbUI7SUFBRSxPQUFPLFlBQVAsT0FBTzs7QUFFbkMsU0FBUyxzQkFBc0IsR0FBRztBQUNoQyxTQUFPLE9BQU8sQ0FBQywrQkFBK0IsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDO0NBQy9EOztJQUVLLHVCQUF1QjtBQWlCaEIsV0FqQlAsdUJBQXVCLENBa0J6QixPQUE0QixFQUU1QjtRQURBLG1CQUF5Qyx5REFBRyxzQkFBc0IsRUFBRTs7MEJBbkJsRSx1QkFBdUI7O0FBcUJ6QixRQUFJLENBQUMsb0JBQW9CLEdBQUcsbUJBQW1CLENBQUM7QUFDaEQsUUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFDO0FBQzlCLFFBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxtQkFBbUIsRUFBRSxDQUFDOztBQUU5QyxRQUFJLENBQUMsa0JBQWtCLEdBQUcsY0FBYyxDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0FBQ3BFLFFBQUksQ0FBQyw0QkFBNEIsR0FBRyxjQUFjLENBQUMsT0FBTyxDQUFDLHFCQUFxQixDQUFDLENBQUM7QUFDbEYsUUFBSSxDQUFDLGdDQUFnQyxHQUFHLGNBQWMsQ0FBQyxPQUFPLENBQUMseUJBQXlCLENBQUMsQ0FBQzs7O0FBRzFGLFFBQUksQ0FBQyxjQUFjLEdBQUcs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QUN4RDs7QUFFRCxNQUFNLENBQUMsT0FBTyxHQUFHLHVCQUF1QixDQUFDIiwiZmlsZSI6Ii92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBwZmw1Mm5wdWJsaXNoX3BhY2thZ2VzL25wbS9udWNsaWRlLWRpYWdub3N0aWNzLXByb3ZpZGVyLWJhc2UvbGliL0RpYWdub3N0aWNzUHJvdmlkZXJCYXNlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBiYWJlbCc7XG4vKiBAZmxvdyAqL1xuXG4vKlxuICogQ29weXJpZ2h0IChjKSAyMDE1LXByZXNlbnQsIEZhY2Vib29rLCBJbmMuXG4gKiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuICpcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIGxpY2Vuc2UgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBpblxuICogdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuXG4gKi9cblxuaW1wb3J0IHR5cGUge1xuICBEaWFnbm9zdGljUHJvdmlkZXJVcGRhdGUsXG4gIEludmFsaWRhdGlvbk1lc3NhZ2UsXG4gIE1lc3NhZ2VJbnZhbGlkYXRpb25DYWxsYmFjayxcbiAgTWVzc2FnZVVwZGF0ZUNhbGxiYWNrLFxufSBmcm9tICdudWNsaWRlLWRpYWdub3N0aWNzLWJhc2UnO1xuaW1wb3J0IHR5cGUge1RleHRFdmVudERpc3BhdGNoZXJ9IGZyb20gJ251Y2xpZGUtdGV4dC1ldmVudC1kaXNwYXRjaGVyJztcblxudHlwZSBQcm92aWRlckJhc2VPcHRpb25zID0ge1xuICAvKiogVGhlIGNhbGxiYWNrIGJ5IHdoaWNoIGEgcHJvdmlkZXIgaXMgbm90aWZpZWQgb2YgdGV4dCBldmVudHMsIHN1Y2ggYXMgYSBmaWxlIHNhdmUuICovXG4gIG9uVGV4dEVkaXRvckV2ZW50PzogKGVkaXRvcjogVGV4dEVkaXRvcikgPT4gbWl4ZWQ7XG4gIC8qKlxuICAgKiBUaGUgY2FsbGJhY2sgYnkgd2hpY2ggYSBwcm92aWRlciBpcyBub3RpZmllZCB0aGF0IGEgbmV3IGNvbnN1bWVyIGhhcyBzdWJzY3JpYmVkIHRvIGRpYWdub3N0aWNcbiAgICogdXBkYXRlcy5cbiAgICovXG4gIG9uTmV3VXBkYXRlU3Vic2NyaWJlcj86IChjYWxsYmFjazogTWVzc2FnZVVwZGF0ZUNhbGxiYWNrKSA9PiBtaXhlZDtcbiAgLyoqXG4gICAqIFRoZSBjYWxsYmFjayBieSB3aGljaCBhIHByb3ZpZGVyIGlzIG5vdGlmaWVkIHRoYXQgYSBuZXcgY29uc3VtZXIgaGFzIHN1YnNjcmliZWQgdG8gZGlhZ25vc3RpY1xuICAgKiBpbnZhbGlkYXRpb25zLlxuICAgKi9cbiAgb25OZXdJbnZhbGlkYXRlU3Vic2NyaWJlcj86IChjYWxsYmFjazogTWVzc2FnZUludmFsaWRhdGlvbkNhbGxiYWNrKSA9PiBtaXhlZDtcbiAgLyoqXG4gICAqIElmIHRydWUsIHRoaXMgd2lsbCBjYXVzZSBvblRleHRFZGl0b3JFdmVudCB0byBnZXQgY2FsbGVkIG1vcmUgb2Z0ZW4gLS0gYXBwcm94aW1hdGVseSB3aGVuZXZlclxuICAgKiB0aGUgdXNlciBzdG9wcyB0eXBpbmcuIElmIGZhbHNlLCBpdCB3aWxsIGdldCBjYWxsZWQgb25seSB3aGVuIHRoZSB1c2VyIHNhdmVzLlxuICAgKi9cbiAgc2hvdWxkUnVuT25UaGVGbHk/OiBib29sZWFuO1xuICAvKipcbiAgICogVGhlIGZvbGxvd2luZyB0d28gb3B0aW9ucyBzcGVjaWZ5IHdoaWNoIGdyYW1tYXJzIHRoZSBwcm92aWRlciBpcyBpbnRlcmVzdGVkIGluLiBNb3N0IHByb3ZpZGVyc1xuICAgKiB3aWxsIGluY2x1ZGUgYSBzZXQgb2YgZ3JhbW1hclNjb3BlcywgYW5kIHdpbGwgdGhlcmVmb3JlIGdldCBub3RpZmljYXRpb25zIG9ubHkgYWJvdXRcbiAgICogVGV4dEVkaXRvcnMgdGhhdCBhcmUgYXNzb2NpYXRlZCB3aXRoIHRob3NlIGdyYW1tYXJTY29wZXMuIEluc3RlYWQsIGEgcHJvdmlkZXIgbWF5IHNldFxuICAgKiBlbmFibGVGb3JBbGxHcmFtbWFycyB0byB0cnVlLCBhbmQgdGhlbiBpdCB3aWxsIGdldCBub3RpZmllZCBvZiBjaGFuZ2VzIGluIGFsbCBUZXh0RWRpdG9ycy4gSWZcbiAgICogZW5hYmxlRm9yQWxsR3JhbW1hcnMgaXMgdHJ1ZSwgaXQgb3ZlcnJpZGVzIHRoZSBncmFtbWFycyBpbiBncmFtbWFyU2NvcGVzLlxuICAgKi9cbiAgZ3JhbW1hclNjb3Blcz86IFNldDxzdHJpbmc+O1xuICBlbmFibGVGb3JBbGxHcmFtbWFycz86IGJvb2xlYW47XG59XG5cbmNvbnN0IFVQREFURV9FVkVOVCA9ICd1cGRhdGUnO1xuY29uc3QgSU5WQUxJREFURV9FVkVOVCA9ICdpbnZhbGlkYXRlJztcblxuY29uc3Qge0NvbXBvc2l0ZURpc3Bvc2FibGUsIEVtaXR0ZXJ9ID0gcmVxdWlyZSgnYXRvbScpO1xuXG5mdW5jdGlvbiBnZXRUZXh0RXZlbnREaXNwYXRjaGVyKCkge1xuICByZXR1cm4gcmVxdWlyZSgnbnVjbGlkZS10ZXh0LWV2ZW50LWRpc3BhdGNoZXInKS5nZXRJbnN0YW5jZSgpO1xufVxuXG5jbGFzcyBEaWFnbm9zdGljc1Byb3ZpZGVyQmFzZSB7XG4gIF90ZXh0RXZlbnREaXNwYXRjaGVyOiBUZXh0RXZlbnREaXNwYXRjaGVyO1xuXG4gIF9lbWl0dGVyOiBFbWl0dGVyO1xuXG4gIF9ncmFtbWFyU2NvcGVzOiBTZXQ8c3RyaW5nPjtcbiAgX2FsbEdyYW1tYXJTY29wZXM6ID9ib29sZWFuO1xuXG4gIF9jdXJyZW50RXZlbnRTdWJzY3JpcHRpb246ID9hdG9tJERpc3Bvc2FibGU7XG5cbiAgX2Rpc3Bvc2FibGVzOiBhdG9tJENvbXBvc2l0ZURpc3Bvc2FibGU7XG5cbiAgLy8gY2FsbGJhY2tzIHByb3ZpZGVkIGJ5IGNsaWVudFxuICBfdGV4dEV2ZW50Q2FsbGJhY2s6IChlZGl0b3I6IFRleHRFZGl0b3IpID0+IG1peGVkO1xuICBfbmV3VXBkYXRlU3Vic2NyaWJlckNhbGxiYWNrOiAoY2FsbGJhY2s6IE1lc3NhZ2VVcGRhdGVDYWxsYmFjaykgPT4gbWl4ZWQ7XG4gIF9uZXdJbnZhbGlkYXRlU3Vic2NyaWJlckNhbGxiYWNrOiAoY2FsbGJhY2s6IE1lc3NhZ2VJbnZhbGlkYXRpb25DYWxsYmFjaykgPT4gbWl4ZWQ7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgb3B0aW9uczogUHJvdmlkZXJCYXNlT3B0aW9ucyxcbiAgICB0ZXh0RXZlbnREaXNwYXRjaGVyPzogVGV4dEV2ZW50RGlzcGF0Y2hlciA9IGdldFRleHRFdmVudERpc3BhdGNoZXIoKSxcbiAgKSB7XG4gICAgdGhpcy5fdGV4dEV2ZW50RGlzcGF0Y2hlciA9IHRleHRFdmVudERpc3BhdGNoZXI7XG4gICAgdGhpcy5fZW1pdHRlciA9IG5ldyBFbWl0dGVyKCk7XG4gICAgdGhpcy5fZGlzcG9zYWJsZXMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpO1xuXG4gICAgdGhpcy5fdGV4dEV2ZW50Q2FsbGJhY2sgPSBjYWxsYmFja09yTm9vcChvcHRpb25zLm9uVGV4dEVkaXRvckV2ZW50KTtcbiAgICB0aGlzLl9uZXdVcGRhdGVTdWJzY3JpYmVyQ2FsbGJhY2sgPSBjYWxsYmFja09yTm9vcChvcHRpb25zLm9uTmV3VXBkYXRlU3Vic2NyaWJlcik7XG4gICAgdGhpcy5fbmV3SW52YWxpZGF0ZVN1YnNjcmliZXJDYWxsYmFjayA9IGNhbGxiYWNrT3JOb29wKG9wdGlvbnMub25OZXdJbnZhbGlkYXRlU3Vic2NyaWJlcik7XG5cbiAgICAvLyBUaGUgU2V0IGNvbnN0cnVjdG9yIGNyZWF0ZXMgYW4gZW1wdHkgU2V0IGlmIHBhc3NlZCBudWxsIG9yIHVuZGVmaW5lZC5cbiAgICB0aGlzLl9ncmFtbWFyU2NvcGVzID0gbmV3IFNldChvcHRpb25zLmdyYW1tYXJTY29wZXMpO1xuICAgIHRoaXMuX2FsbEdyYW1tYXJTY29wZXMgPSAhIW9wdGlvbnMuZW5hYmxlRm9yQWxsR3JhbW1hcnM7XG4gICAgdGhpcy5fc3Vic2NyaWJlVG9UZXh0RWRpdG9yRXZlbnQoISFvcHRpb25zLnNob3VsZFJ1bk9uVGhlRmx5KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTdWJzY3JpYmVzIHRvIHRoZSBhcHByb3ByaWF0ZSBldmVudCBkZXBlbmRpbmcgb24gd2hldGhlciB3ZSBzaG91bGQgcnVuIG9uXG4gICAqIHRoZSBmbHkgb3Igbm90LlxuICAgKi9cbiAgX3N1YnNjcmliZVRvVGV4dEVkaXRvckV2ZW50KHNob3VsZFJ1bk9uVGhlRmx5OiBib29sZWFuKSB7XG4gICAgdGhpcy5fZGlzcG9zZUV2ZW50U3Vic2NyaXB0aW9uKCk7XG4gICAgY29uc3QgZGlzcGF0Y2hlciA9IHRoaXMuX3RleHRFdmVudERpc3BhdGNoZXI7XG4gICAgbGV0IHN1YnNjcmlwdGlvbjtcbiAgICBpZiAoc2hvdWxkUnVuT25UaGVGbHkpIHtcbiAgICAgIGlmICh0aGlzLl9hbGxHcmFtbWFyU2NvcGVzKSB7XG4gICAgICAgIHN1YnNjcmlwdGlvbiA9IGRpc3BhdGNoZXIub25BbnlGaWxlQ2hhbmdlKHRoaXMuX3RleHRFdmVudENhbGxiYWNrKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHN1YnNjcmlwdGlvbiA9IGRpc3BhdGNoZXIub25GaWxlQ2hhbmdlKHRoaXMuX2dyYW1tYXJTY29wZXMsIHRoaXMuX3RleHRFdmVudENhbGxiYWNrKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHRoaXMuX2FsbEdyYW1tYXJTY29wZXMpIHtcbiAgICAgICAgc3Vic2NyaXB0aW9uID0gZGlzcGF0Y2hlci5vbkFueUZpbGVTYXZlKHRoaXMuX3RleHRFdmVudENhbGxiYWNrKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHN1YnNjcmlwdGlvbiA9IGRpc3BhdGNoZXIub25GaWxlU2F2ZSh0aGlzLl9ncmFtbWFyU2NvcGVzLCB0aGlzLl90ZXh0RXZlbnRDYWxsYmFjayk7XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuX2N1cnJlbnRFdmVudFN1YnNjcmlwdGlvbiA9IHN1YnNjcmlwdGlvbjtcbiAgfVxuXG4gIHNldFJ1bk9uVGhlRmx5KHJ1bk9uVGhlRmx5OiBib29sZWFuKSB7XG4gICAgdGhpcy5fc3Vic2NyaWJlVG9UZXh0RWRpdG9yRXZlbnQocnVuT25UaGVGbHkpO1xuICB9XG5cbiAgZGlzcG9zZSgpOiB2b2lkIHtcbiAgICB0aGlzLl9lbWl0dGVyLmRpc3Bvc2UoKTtcbiAgICB0aGlzLl9kaXNwb3NhYmxlcy5kaXNwb3NlKCk7XG4gICAgdGhpcy5fZGlzcG9zZUV2ZW50U3Vic2NyaXB0aW9uKCk7XG4gIH1cblxuICBfZGlzcG9zZUV2ZW50U3Vic2NyaXB0aW9uKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLl9jdXJyZW50RXZlbnRTdWJzY3JpcHRpb24pIHtcbiAgICAgIHRoaXMuX2N1cnJlbnRFdmVudFN1YnNjcmlwdGlvbi5kaXNwb3NlKCk7XG4gICAgICB0aGlzLl9jdXJyZW50RXZlbnRTdWJzY3JpcHRpb24gPSBudWxsO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBDbGllbnRzIGNhbiBjYWxsIHRoZXNlIG1ldGhvZHMgdG8gcHVibGlzaCBtZXNzYWdlc1xuICAgKi9cblxuICBwdWJsaXNoTWVzc2FnZVVwZGF0ZSh1cGRhdGU6IERpYWdub3N0aWNQcm92aWRlclVwZGF0ZSk6IHZvaWQge1xuICAgIHRoaXMuX2VtaXR0ZXIuZW1pdChVUERBVEVfRVZFTlQsIHVwZGF0ZSk7XG4gIH1cblxuICBwdWJsaXNoTWVzc2FnZUludmFsaWRhdGlvbihtZXNzYWdlOiBJbnZhbGlkYXRpb25NZXNzYWdlKTogdm9pZCB7XG4gICAgdGhpcy5fZW1pdHRlci5lbWl0KElOVkFMSURBVEVfRVZFTlQsIG1lc3NhZ2UpO1xuICB9XG5cbiAgLyoqXG4gICAqIENsaWVudHMgc2hvdWxkIGRlbGVnYXRlIHRvIHRoZXNlXG4gICAqL1xuXG4gIG9uTWVzc2FnZVVwZGF0ZShjYWxsYmFjazogTWVzc2FnZVVwZGF0ZUNhbGxiYWNrKTogYXRvbSREaXNwb3NhYmxlIHtcbiAgICBjb25zdCBkaXNwb3NhYmxlID0gdGhpcy5fZW1pdHRlci5vbihVUERBVEVfRVZFTlQsIGNhbGxiYWNrKTtcbiAgICB0aGlzLl9uZXdVcGRhdGVTdWJzY3JpYmVyQ2FsbGJhY2soY2FsbGJhY2spO1xuICAgIHJldHVybiBkaXNwb3NhYmxlO1xuICB9XG5cbiAgb25NZXNzYWdlSW52YWxpZGF0aW9uKGNhbGxiYWNrOiBNZXNzYWdlSW52YWxpZGF0aW9uQ2FsbGJhY2spOiBhdG9tJERpc3Bvc2FibGUge1xuICAgIGNvbnN0IGRpc3Bvc2FibGUgPSB0aGlzLl9lbWl0dGVyLm9uKElOVkFMSURBVEVfRVZFTlQsIGNhbGxiYWNrKTtcbiAgICB0aGlzLl9uZXdJbnZhbGlkYXRlU3Vic2NyaWJlckNhbGxiYWNrKGNhbGxiYWNrKTtcbiAgICByZXR1cm4gZGlzcG9zYWJsZTtcbiAgfVxufVxuXG5mdW5jdGlvbiBjYWxsYmFja09yTm9vcDxUPihjYWxsYmFjazogPyhhcmc6IFQpID0+IG1peGVkKTogKGFyZzogVCkgPT4gbWl4ZWQge1xuICByZXR1cm4gY2FsbGJhY2sgPyBjYWxsYmFjay5iaW5kKHVuZGVmaW5lZCkgOiAoKSA9PiB7IH07XG59XG5cbm1vZHVsZS5leHBvcnRzID0gRGlhZ25vc3RpY3NQcm92aWRlckJhc2U7XG4iXX0=
