
/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

var _createClass = (function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ('value' in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; })();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError('Cannot call a class as a function'); } }

var invariant = require('assert');

var _require = require('atom');

var CompositeDisposable = _require.CompositeDisposable;
var Disposable = _require.Disposable;
var Emitter = _require.Emitter;
var Point = _require.Point;

var DEBOUNCE_TIME = 200;

var WindowMouseListener = (function () {
  function WindowMouseListener() {
    var _this = this;

    _classCallCheck(this, WindowMouseListener);

    this._subscriptions = new CompositeDisposable();

    var _require2 = require('nuclide-commons');

    var debounce = _require2.debounce;

    var handler = debounce(function (event) {
      return _this._handleMouseMove(event);
    }, DEBOUNCE_TIME,
    /* immediate */true);
    window.addEventListener('mousemove', handler);
    this._mouseMoveListener = new Disposable(function () {
      window.removeEventListener('mousemove', handler);
    });

    this._textEditorMouseListenersMap = new Map();
    this._textEditorMouseListenersCountMap = new Map();
    this._subscriptions.add(new Disposable(function () {
      _this._textEditorMouseListenersMap.forEach(function (listener) {
        return listener.dispose();
      });
      _this._textEditorMouseListenersMap.clear();
      _this._textEditorMouseListenersCountMap.clear();
    }));
  }

  _createClass(WindowMouseListener, [{
    key: 'mouseListenerForTextEditor',
    value: function mouseListenerForTextEditor(textEditor) {
      var _this2 = this;

      // Keep track of how many mouse listeners were returned for the text editor
      // so we know when it's safe to actually dispose it.
      var count = this._textEditorMouseListenersCountMap.get(textEditor) || 0;
      this._textEditorMouseListenersCountMap.set(textEditor, count + 1);

      var mouseListener = this._textEditorMouseListenersMap.get(textEditor);
      if (!mouseListener) {
        (function () {
          mouseListener = new TextEditorMouseListener(textEditor, /* shouldDispose */function () {
            var currentCount = _this2._textEditorMouseListenersCountMap.get(textEditor) || 0;
            if (currentCount === 1) {
              _this2._textEditorMouseListenersCountMap['delete'](textEditor);
              _this2._textEditorMouseListenersMap['delete'](textEditor);
              return true;
            } else {
              _this2._textEditorMouseListenersCountMap.set(textEditor, currentCount - 1);
              return false;
            }
          });
          _this2._textEditorMouseListenersMap.set(textEditor, mouseListener);

          var destroySubscription = textEditor.onDidDestroy(function () {
            mouseListener.dispose();
            _this2._textEditorMouseListenersMap['delete'](textEditor);
            _this2._textEditorMouseListenersCountMap['delete'](textEditor);
            destroySubscription.dispose();
          });
        })();
      }
      return mouseListener;
    }
  }, {
    key: '_handleMouseMove',
    value: function _handleMouseMove(event) {
      this._textEditorMouseListenersMap.forEach(function (mouseListener) {
        return mouseListener._handleMouseMove(event);
      });
    }
  }, {
    key: 'dispose',
    value: function dispose() {
      this._subscriptions.dispose();
      if (this._mouseMoveListener) {
        this._mouseMoveListener.dispose();
      }
    }
  }]);

  return WindowMouseListener;
})();

var TextEditorMouseListener = (function () {
  function TextEditorMouseListener(textEditor, shouldDispose) {
    _classCallCheck(this, TextEditorMouseListener);

    this._textEditor = textEditor;
    this._textEditorView = atom.views.getView(this._textEditor);

    this._shouldDispose = shouldDispose;
    this._subscriptions = new CompositeDisposable();

    this._emitter = new Emitter();
    this._subscriptions.add(this._emitter);

    this._lastPosition = new Point(0, 0);
  }

  /**
   * Returns the last known text editor screen position under the mouse,
   * initialized to (0, 0).
   */

  _createClass(TextEditorMouseListener, [{
    key: 'getLastPosition',
    value: function getLastPosition() {
      return this._lastPosition;
    }

    /**
     * Calls `fn` when the mouse moves onto another text editor screen position,
     * not pixel position.
     */
  }, {
    key: 'onDidPositionChange',
    value: function onDidPositionChange(fn) {
      return this._emitter.on('did-position-change', fn);
    }
  }, {
    key: 'screenPositionForMouseEvent',
    value: function screenPositionForMouseEvent(event) {
      var component = this._textEditorView.component;
      invariant(component);
      return component.screenPositionForMouseEvent(event);
    }
  }, {
    key: '_handleMouseMove',
    value: function _handleMouseMove(event) {
      var position = this.screenPositionForMouseEvent(event);
      if (position.compare(this._lastPosition) !== 0) {
        this._lastPosition = position;
        this._emitter.emit('did-position-change', {
          nativeEvent: event,
          position: position
        });
      }
    }
  }, {
    key: 'dispose',
    value: function dispose() {
      if (this._shouldDispose()) {
        this._subscriptions.dispose();
      }
    }
  }]);

  return TextEditorMouseListener;
})();

module.exports =
/**
 * Returns an object that tracks the mouse position in a text editor.
 *
 * The positions are in text editor screen coordinates and are rounded down
 * to the last position on each line.
 */
function mouseListenerForTextEditor(textEditor) {
  // $FlowFixMe
  atom.nuclide = atom.nuclide || {};
  atom.nuclide.windowMouseListener = atom.nuclide.windowMouseListener || new WindowMouseListener();
  return atom.nuclide.windowMouseListener.mouseListenerForTextEditor(textEditor);
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBwZmw1Mm5wdWJsaXNoX3BhY2thZ2VzL25wbS9udWNsaWRlLWF0b20taGVscGVycy9saWIvbW91c2UtbGlzdGVuZXItZm9yLXRleHQtZWRpdG9yLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFdBQVcsQ0FBQzs7Ozs7Ozs7Ozs7Ozs7QUFVWixJQUFNLFNBQVMsR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7O2VBQ3NCLE9BQU8sQ0FBQyxNQUFNLENBQUM7O0lBQWxFLG1CQUFtQixZQUFuQixtQkFBbUI7SUFBRSxVQUFVLFlBQVYsVUFBVTtJQUFFLE9BQU8sWUFBUCxPQUFPO0lBQUUsS0FBSyxZQUFMLEtBQUs7O0FBT3RELElBQU0sYUFBYSxHQUFHLEdBQUcsQ0FBQzs7SUFFcEIsbUJBQW1CO0FBTVosV0FOUCxtQkFBbUIsR0FNVDs7OzBCQU5WLG1CQUFtQjs7QUFPckIsUUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLG1CQUFtQixFQUFFLENBQUM7O29CQUU3QixPQUFPLENBQUMsaUJBQWlCLENBQUM7O1FBQXRDLFFBQVEsYUFBUixRQUFROztBQUNmLFFBQU0sT0FBTyxHQUFHLFFBQVEsQ0FDcEIsVUFBQSxLQUFLO2FBQUksTUFBSyxnQkFBZ0IsQ0FBQyxLQUFLLENBQUM7S0FBQSxFQUNyQyxhQUFhO21CQUNHLElBQUksQ0FBQyxDQUFDO0FBQzFCLFVBQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLEVBQUUsT0FBTyxDQUFDLENBQUM7QUFDOUMsUUFBSSxDQUFDLGtCQUFrQixHQUFHLElBQUksVUFBVSxDQUFDLFlBQU07QUFDN0MsWUFBTSxDQUFDLG1CQUFtQixDQUFDLFdBQVcsRUFBRSxPQUFPLENBQUMsQ0FBQztLQUNsRCxDQUFDLENBQUM7O0FBRUgsUUFBSSxDQUFDLDRCQUE0QixHQUFHLElBQUksR0FBRyxFQUFFLENBQUM7QUFDOUMsUUFBSSxD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LENBQUMsY0FBYyxDQUFDLE9BQU8sRUFBRSxDQUFDO09BQy9CO0tBQ0Y7OztTQTFERyx1QkFBdUI7OztBQTZEN0IsTUFBTSxDQUFDLE9BQU87Ozs7Ozs7QUFPZCxTQUFTLDBCQUEwQixDQUFDLFVBQXNCLEVBQTJCOztBQUVuRixNQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxPQUFPLElBQUksRUFBRSxDQUFDO0FBQ2xDLE1BQUksQ0FBQyxPQUFPLENBQUMsbUJBQW1CLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxtQkFBbUIsSUFBSSxJQUFJLG1CQUFtQixFQUFFLENBQUM7QUFDakcsU0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLG1CQUFtQixDQUFDLDBCQUEwQixDQUFDLFVBQVUsQ0FBQyxDQUFDO0NBQ2hGLENBQUMiLCJmaWxlIjoiL3Zhci9mb2xkZXJzL3hmL3JzcGg0X2M1NzMxNXJzNTd4eHNkc2tyeG52MzZ0MC9UL3RtcHBmbDUybnB1Ymxpc2hfcGFja2FnZXMvbnBtL251Y2xpZGUtYXRvbS1oZWxwZXJzL2xpYi9tb3VzZS1saXN0ZW5lci1mb3ItdGV4dC1lZGl0b3IuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIGJhYmVsJztcbi8qIEBmbG93ICovXG5cbi8qXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTUtcHJlc2VudCwgRmFjZWJvb2ssIEluYy5cbiAqIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgbGljZW5zZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGluXG4gKiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS5cbiAqL1xuY29uc3QgaW52YXJpYW50ID0gcmVxdWlyZSgnYXNzZXJ0Jyk7XG5jb25zdCB7Q29tcG9zaXRlRGlzcG9zYWJsZSwgRGlzcG9zYWJsZSwgRW1pdHRlciwgUG9pbnR9ID0gcmVxdWlyZSgnYXRvbScpO1xuXG50eXBlIFBvc2l0aW9uQ2hhbmdlRXZlbnQgPSB7XG4gIG5hdGl2ZUV2ZW50OiBNb3VzZUV2ZW50O1xuICBwb3NpdGlvbjogUG9pbnQ7XG59O1xuXG5jb25zdCBERUJPVU5DRV9USU1FID0gMjAwO1xuXG5jbGFzcyBXaW5kb3dNb3VzZUxpc3RlbmVyIHtcbiAgX3N1YnNjcmlwdGlvbnM6IENvbXBvc2l0ZURpc3Bvc2FibGU7XG4gIF9tb3VzZU1vdmVMaXN0ZW5lcjogRGlzcG9zYWJsZTtcbiAgX3RleHRFZGl0b3JNb3VzZUxpc3RlbmVyc01hcDogTWFwPFRleHRFZGl0b3IsIFRleHRFZGl0b3JNb3VzZUxpc3RlbmVyPjtcbiAgX3RleHRFZGl0b3JNb3VzZUxpc3RlbmVyc0NvdW50TWFwOiBNYXA8VGV4dEVkaXRvciwgbnVtYmVyPjtcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLl9zdWJzY3JpcHRpb25zID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKTtcblxuICAgIGNvbnN0IHtkZWJvdW5jZX0gPSByZXF1aXJlKCdudWNsaWRlLWNvbW1vbnMnKTtcbiAgICBjb25zdCBoYW5kbGVyID0gZGVib3VuY2UoXG4gICAgICAgIGV2ZW50ID0+IHRoaXMuX2hhbmRsZU1vdXNlTW92ZShldmVudCksXG4gICAgICAgIERFQk9VTkNFX1RJTUUsXG4gICAgICAgIC8qIGltbWVkaWF0ZSAqLyB0cnVlKTtcbiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgaGFuZGxlcik7XG4gICAgdGhpcy5fbW91c2VNb3ZlTGlzdGVuZXIgPSBuZXcgRGlzcG9zYWJsZSgoKSA9PiB7XG4gICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgaGFuZGxlcik7XG4gICAgfSk7XG5cbiAgICB0aGlzLl90ZXh0RWRpdG9yTW91c2VMaXN0ZW5lcnNNYXAgPSBuZXcgTWFwKCk7XG4gICAgdGhpcy5fdGV4dEVkaXRvck1vdXNlTGlzdGVuZXJzQ291bnRNYXAgPSBuZXcgTWFwKCk7XG4gICAgdGhpcy5fc3Vic2NyaXB0aW9ucy5hZGQobmV3IERpc3Bvc2FibGUoKCkgPT4ge1xuICAgICAgdGhpcy5fdGV4dEVkaXRvck1vdXNlTGlzdGVuZXJzTWFwLmZvckVhY2gobGlzdGVuZXIgPT4gbGlzdGVuZXIuZGlzcG9zZSgpKTtcbiAgICAgIHRoaXMuX3RleHRFZGl0b3JNb3VzZUxpc3RlbmVyc01hcC5jbGVhcigpO1xuICAgICAgdGhpcy5fdGV4dEVkaXRvck1vdXNlTGlzdGVuZXJzQ291bnRNYXAuY2xlYXIoKTtcbiAgICB9KSk7XG4gIH1cblxuICBtb3VzZUxpc3RlbmVyRm9yVGV4dEVkaXRvcih0ZXh0RWRpdG9yOiBUZXh0RWRpdG9yKTogVGV4dEVkaXRvck1vdXNlTGlzdGVuZXIge1xuICAgIC8vIEtlZXAgdHJhY2sgb2YgaG93IG1hbnkgbW91c2UgbGlzdGVuZXJzIHdlcmUgcmV0dXJuZWQgZm9yIHRoZSB0ZXh0IGVkaXRvclxuICAgIC8vIHNvIHdlIGtub3cgd2hlbiBpdCdzIHNhZmUgdG8gYWN0dWFsbHkgZGlzcG9zZSBpdC5cbiAgICBjb25zdCBjb3VudCA9IHRoaXMuX3RleHRFZGl0b3JNb3VzZUxpc3RlbmVyc0NvdW50TWFwLmdldCh0ZXh0RWRpdG9yKSB8fCAwO1xuICAgIHRoaXMuX3RleHRFZGl0b3JNb3VzZUxpc3RlbmVyc0NvdW50TWFwLnNldCh0ZXh0RWRpdG9yLCBjb3VudCArIDEpO1xuXG4gICAgbGV0IG1vdXNlTGlzdGVuZXIgPSB0aGlzLl90ZXh0RWRpdG9yTW91c2VMaXN0ZW5lcnNNYXAuZ2V0KHRleHRFZGl0b3IpO1xuICAgIGlmICghbW91c2VMaXN0ZW5lcikge1xuICAgICAgbW91c2VMaXN0ZW5lciA9IG5ldyBUZXh0RWRpdG9yTW91c2VMaXN0ZW5lcih0ZXh0RWRpdG9yLCAvKiBzaG91bGREaXNwb3NlICovICgpID0+IHtcbiAgICAgICAgY29uc3QgY3VycmVudENvdW50ID0gdGhpcy5fdGV4dEVkaXRvck1vdXNlTGlzdGVuZXJzQ291bnRNYXAuZ2V0KHRleHRFZGl0b3IpIHx8IDA7XG4gICAgICAgIGlmIChjdXJyZW50Q291bnQgPT09IDEpIHtcbiAgICAgICAgICB0aGlzLl90ZXh0RWRpdG9yTW91c2VMaXN0ZW5lcnNDb3VudE1hcC5kZWxldGUodGV4dEVkaXRvcik7XG4gICAgICAgICAgdGhpcy5fdGV4dEVkaXRvck1vdXNlTGlzdGVuZXJzTWFwLmRlbGV0ZSh0ZXh0RWRpdG9yKTtcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLl90ZXh0RWRpdG9yTW91c2VMaXN0ZW5lcnNDb3VudE1hcC5zZXQodGV4dEVkaXRvciwgY3VycmVudENvdW50IC0gMSk7XG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIHRoaXMuX3RleHRFZGl0b3JNb3VzZUxpc3RlbmVyc01hcC5zZXQodGV4dEVkaXRvciwgbW91c2VMaXN0ZW5lcik7XG5cbiAgICAgIGNvbnN0IGRlc3Ryb3lTdWJzY3JpcHRpb24gPSB0ZXh0RWRpdG9yLm9uRGlkRGVzdHJveSgoKSA9PiB7XG4gICAgICAgIG1vdXNlTGlzdGVuZXIuZGlzcG9zZSgpO1xuICAgICAgICB0aGlzLl90ZXh0RWRpdG9yTW91c2VMaXN0ZW5lcnNNYXAuZGVsZXRlKHRleHRFZGl0b3IpO1xuICAgICAgICB0aGlzLl90ZXh0RWRpdG9yTW91c2VMaXN0ZW5lcnNDb3VudE1hcC5kZWxldGUodGV4dEVkaXRvcik7XG4gICAgICAgIGRlc3Ryb3lTdWJzY3JpcHRpb24uZGlzcG9zZSgpO1xuICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiBtb3VzZUxpc3RlbmVyO1xuICB9XG5cbiAgX2hhbmRsZU1vdXNlTW92ZShldmVudDogTW91c2VFdmVudCk6IHZvaWQge1xuICAgIHRoaXMuX3RleHRFZGl0b3JNb3VzZUxpc3RlbmVyc01hcC5mb3JFYWNoKFxuICAgICAgICBtb3VzZUxpc3RlbmVyID0+IG1vdXNlTGlzdGVuZXIuX2hhbmRsZU1vdXNlTW92ZShldmVudCkpO1xuICB9XG5cbiAgZGlzcG9zZSgpOiB2b2lkIHtcbiAgICB0aGlzLl9zdWJzY3JpcHRpb25zLmRpc3Bvc2UoKTtcbiAgICBpZiAodGhpcy5fbW91c2VNb3ZlTGlzdGVuZXIpIHtcbiAgICAgIHRoaXMuX21vdXNlTW92ZUxpc3RlbmVyLmRpc3Bvc2UoKTtcbiAgICB9XG4gIH1cbn1cblxuY2xhc3MgVGV4dEVkaXRvck1vdXNlTGlzdGVuZXIge1xuICBfdGV4dEVkaXRvcjogVGV4dEVkaXRvcjtcbiAgX3RleHRFZGl0b3JWaWV3OiBhdG9tJFRleHRFZGl0b3JFbGVtZW50O1xuICBfc2hvdWxkRGlzcG9zZTogKCkgPT4gYm9vbGVhbjtcbiAgX3N1YnNjcmlwdGlvbnM6IENvbXBvc2l0ZURpc3Bvc2FibGU7XG4gIF9lbWl0dGVyOiBFbWl0dGVyO1xuICBfbGFzdFBvc2l0aW9uOiBhdG9tJFBvaW50O1xuXG4gIGNvbnN0cnVjdG9yKHRleHRFZGl0b3I6IFRleHRFZGl0b3IsIHNob3VsZERpc3Bvc2U6ICgpID0+IGJvb2xlYW4pIHtcbiAgICB0aGlzLl90ZXh0RWRpdG9yID0gdGV4dEVkaXRvcjtcbiAgICB0aGlzLl90ZXh0RWRpdG9yVmlldyA9IGF0b20udmlld3MuZ2V0Vmlldyh0aGlzLl90ZXh0RWRpdG9yKTtcblxuICAgIHRoaXMuX3Nob3VsZERpc3Bvc2UgPSBzaG91bGREaXNwb3NlO1xuICAgIHRoaXMuX3N1YnNjcmlwdGlvbnMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpO1xuXG4gICAgdGhpcy5fZW1pdHRlciA9IG5ldyBFbWl0dGVyKCk7XG4gICAgdGhpcy5fc3Vic2NyaXB0aW9ucy5hZGQodGhpcy5fZW1pdHRlcik7XG5cbiAgICB0aGlzLl9sYXN0UG9zaXRpb24gPSBuZXcgUG9pbnQoMCwgMCk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgbGFzdCBrbm93biB0ZXh0IGVkaXRvciBzY3JlZW4gcG9zaXRpb24gdW5kZXIgdGhlIG1vdXNlLFxuICAgKiBpbml0aWFsaXplZCB0byAoMCwgMCkuXG4gICAqL1xuICBnZXRMYXN0UG9zaXRpb24oKTogUG9pbnQge1xuICAgIHJldHVybiB0aGlzLl9sYXN0UG9zaXRpb247XG4gIH1cblxuICAvKipcbiAgICogQ2FsbHMgYGZuYCB3aGVuIHRoZSBtb3VzZSBtb3ZlcyBvbnRvIGFub3RoZXIgdGV4dCBlZGl0b3Igc2NyZWVuIHBvc2l0aW9uLFxuICAgKiBub3QgcGl4ZWwgcG9zaXRpb24uXG4gICAqL1xuICBvbkRpZFBvc2l0aW9uQ2hhbmdlKGZuOiAoZXZlbnQ6IFBvc2l0aW9uQ2hhbmdlRXZlbnQpID0+IHZvaWQpOiBEaXNwb3NhYmxlIHtcbiAgICByZXR1cm4gdGhpcy5fZW1pdHRlci5vbignZGlkLXBvc2l0aW9uLWNoYW5nZScsIGZuKTtcbiAgfVxuXG4gIHNjcmVlblBvc2l0aW9uRm9yTW91c2VFdmVudChldmVudDogTW91c2VFdmVudCk6IFBvaW50IHtcbiAgICBjb25zdCBjb21wb25lbnQgPSB0aGlzLl90ZXh0RWRpdG9yVmlldy5jb21wb25lbnQ7XG4gICAgaW52YXJpYW50KGNvbXBvbmVudCk7XG4gICAgcmV0dXJuIGNvbXBvbmVudC5zY3JlZW5Qb3NpdGlvbkZvck1vdXNlRXZlbnQoZXZlbnQpO1xuICB9XG5cbiAgX2hhbmRsZU1vdXNlTW92ZShldmVudDogTW91c2VFdmVudCk6IHZvaWQge1xuICAgIGNvbnN0IHBvc2l0aW9uID0gdGhpcy5zY3JlZW5Qb3NpdGlvbkZvck1vdXNlRXZlbnQoZXZlbnQpO1xuICAgIGlmIChwb3NpdGlvbi5jb21wYXJlKHRoaXMuX2xhc3RQb3NpdGlvbikgIT09IDApIHtcbiAgICAgIHRoaXMuX2xhc3RQb3NpdGlvbiA9IHBvc2l0aW9uO1xuICAgICAgdGhpcy5fZW1pdHRlci5lbWl0KCdkaWQtcG9zaXRpb24tY2hhbmdlJywge1xuICAgICAgICBuYXRpdmVFdmVudDogZXZlbnQsXG4gICAgICAgIHBvc2l0aW9uLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgZGlzcG9zZSgpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5fc2hvdWxkRGlzcG9zZSgpKSB7XG4gICAgICB0aGlzLl9zdWJzY3JpcHRpb25zLmRpc3Bvc2UoKTtcbiAgICB9XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPVxuLyoqXG4gKiBSZXR1cm5zIGFuIG9iamVjdCB0aGF0IHRyYWNrcyB0aGUgbW91c2UgcG9zaXRpb24gaW4gYSB0ZXh0IGVkaXRvci5cbiAqXG4gKiBUaGUgcG9zaXRpb25zIGFyZSBpbiB0ZXh0IGVkaXRvciBzY3JlZW4gY29vcmRpbmF0ZXMgYW5kIGFyZSByb3VuZGVkIGRvd25cbiAqIHRvIHRoZSBsYXN0IHBvc2l0aW9uIG9uIGVhY2ggbGluZS5cbiAqL1xuZnVuY3Rpb24gbW91c2VMaXN0ZW5lckZvclRleHRFZGl0b3IodGV4dEVkaXRvcjogVGV4dEVkaXRvcik6IFRleHRFZGl0b3JNb3VzZUxpc3RlbmVyIHtcbiAgLy8gJEZsb3dGaXhNZVxuICBhdG9tLm51Y2xpZGUgPSBhdG9tLm51Y2xpZGUgfHwge307XG4gIGF0b20ubnVjbGlkZS53aW5kb3dNb3VzZUxpc3RlbmVyID0gYXRvbS5udWNsaWRlLndpbmRvd01vdXNlTGlzdGVuZXIgfHwgbmV3IFdpbmRvd01vdXNlTGlzdGVuZXIoKTtcbiAgcmV0dXJuIGF0b20ubnVjbGlkZS53aW5kb3dNb3VzZUxpc3RlbmVyLm1vdXNlTGlzdGVuZXJGb3JUZXh0RWRpdG9yKHRleHRFZGl0b3IpO1xufTtcbiJdfQ==
