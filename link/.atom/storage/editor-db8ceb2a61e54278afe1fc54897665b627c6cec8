{"mode":"editor","version":1,"windowDimensions":{"x":0,"y":22,"width":958,"height":1178,"maximized":false},"grammars":{"deserializer":"GrammarRegistry","grammarOverridesByPath":{}},"project":{"paths":["/Users/lonnen/repos/security/operations/aws-security-auditor"],"buffers":[{"text":"These instructions show how to both create a *trusted* IAM role (likely in \nthe moz-opsec AWS account) and a *trusting* IAM role in foreign AWS accounts. \nThis will allow other Mozilla teams with AWS accounts to delegate permissions \nto OpSec to enable OpSec to perform security audits.\n\nThe policy in the *trusting* account contains a list of permissions which come \nfrom the AWS built in \"Security Audit\" IAM role.\n\n# Trusting Account\n\nHere's how to create an IAM role for the trusting account. This would be done \nby a foreign AWS account holder who wants to grant OpSec the ability to audit \nthe security of their AWS account.\n\n## Create a Trusting Account using cloudformation\n\nThis method is preferred over using boto.\n\n* The foreign AWS account holder should log into their AWS web console\n* Browse to the [CloudFormation section](https://console.aws.amazon.com/cloudformation/home?region=us-west-2)\n* Click the `Create Stack` button\n  * In the `Name` field enter something like `opsec-security-audit-role`\n  * In the `Source` field select `Specify an Amazon S3 template URL` and type in \n \n    https://s3-us-west-2.amazonaws.com/opsec-cloudformation-templates/opsec-security-audit-trusting-role-cloudformation.json\n\n* Click the `Next` button\n* Deploy the `opsec-security-audit-trusting-role-cloudformation.json` template\n* On the `Options` page click the `Next` button\n* On the `Review` page click the checkbox that says `I acknowledge that this template might cause AWS CloudFormation to create IAM resources.`\n* Click the `Create` button\n* When the CloudFormation stack completes the creation process and the `Status` field changes from `CREATE_IN_PROGRESS` to `CREATE_COMPLETE`, select the new stack and click the `Outputs` tab in the bottom window pane.\n* Copy the `Value` given for the `OpSecSecurityAuditRoleARN` `Key` and paste it into the bug that OpSec opened requesting the creation of this account\n  * An example `Value` would be `arn:aws:iam::123456789012:role/opsec-security-audit-role-OpSecSecurityAuditRole-1234567890AB`\n\n## Create a Trusting Account using boto\n\nThis is not the preferred method to grant these rights. The cloudformation template described later\nis preferred.\n\n```\n#!/usr/bin/env python\n\n# Set this to the ARN of the trusted account role\ntrusted_account_role_arn=\"arn:aws:iam::656532927350:role/OpSecTrustedAuditor\"\n\nimport boto.iam\nconn_iam = boto.iam.connect_to_region('universal')\nrole_name='OpSecSeucrityAudit'\ninstance_profile_name='OpSecSeucrityAuditInstanceProfile'\nassume_role_policy_document = '''{\n  \"Version\":\"2012-10-17\",\n  \"Statement\":[\n    {\n      \"Sid\":\"\",\n      \"Effect\":\"Allow\",\n      \"Principal\":{\n        \"AWS\":\"%s\"\n      },\n      \"Action\":\"sts:AssumeRole\"\n    }\n  ]\n}''' % trusted_account_role_arn\npolicy_name = \"SecurityAudit\"\npolicy_document = '''{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Action\": [\n        \"autoscaling:Describe*\",\n        \"cloudformation:DescribeStack*\",\n        \"cloudformation:GetTemplate\",\n        \"cloudformation:ListStack*\",\n        \"cloudfront:Get*\",\n        \"cloudfront:List*\",\n        \"cloudwatch:Describe*\",\n        \"directconnect:Describe*\",\n        \"dynamodb:ListTables\",\n        \"ec2:Describe*\",\n        \"elasticbeanstalk:Describe*\",\n        \"elasticache:Describe*\",\n        \"elasticloadbalancing:Describe*\",\n        \"elasticmapreduce:DescribeJobFlows\",\n        \"glacier:ListVaults\",\n        \"iam:Get*\",\n        \"iam:List*\",\n        \"rds:Describe*\",\n        \"rds:DownloadDBLogFilePortion\",\n        \"rds:ListTagsForResource\",\n        \"redshift:Describe*\",\n        \"route53:GetHostedZone\",\n        \"route53:ListHostedZones\",\n        \"route53:ListResourceRecordSets\",\n        \"s3:GetBucket*\",\n        \"s3:GetLifecycleConfiguration\",\n        \"s3:GetObjectAcl\",\n        \"s3:GetObjectVersionAcl\",\n        \"s3:ListAllMyBuckets\",\n        \"sdb:DomainMetadata\",\n        \"sdb:ListDomains\",\n        \"sns:GetTopicAttributes\",\n        \"sns:ListTopics\",\n        \"sqs:GetQueueAttributes\",\n        \"sqs:ListQueues\"\n      ],\n      \"Effect\": \"Allow\",\n      \"Resource\": \"*\"\n    }\n  ]\n}'''\n\nprint(conn_iam.create_role(role_name=role_name,\n      assume_role_policy_document=assume_role_policy_document))\n\nprint(conn_iam.put_role_policy(role_name=role_name,\n      policy_name=policy_name,\n      policy_document=policy_document))\nprint(conn_iam.create_instance_profile(instance_profile_name))\nprint(conn_iam.add_role_to_instance_profile(instance_profile_name,\n                                            role_name))\n\n```\n\n# Trusted account\n\nThis IAM role is created in an OpSec controlled AWS account (likely the \nmoz-opsec account) and is the role which the *trusting* accounts delegate\npermissions to.\n\nNote, since the trusted account must have a predictable ARN to be referenced\nby the *trusting* accounts it can not be created with cloudformation.\n\n```\nimport boto.iam\nconn_iam = boto.iam.connect_to_region('universal')\nrole_name='OpSecTrustedAuditor'\ninstance_profile_name='OpSecTrustedAuditorInstanceProfile'\nassume_role_policy_document = '''{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"\",\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"Service\": \"ec2.amazonaws.com\"\n      },\n      \"Action\": \"sts:AssumeRole\"\n    }\n  ]\n}'''\npolicy_name = 'OpSecTrustedAuditorPerms'\npolicy_document = '''{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"Allow\",\n      \"Action\": \"sts:AssumeRole\",\n      \"Resource\": \"*\"\n    }\n  ]\n}'''\n\nprint(conn_iam.create_role(role_name=role_name,\n                           assume_role_policy_document=assume_role_policy_document))\nprint(conn_iam.put_role_policy(role_name=role_name,\n                               policy_name=policy_name,\n                               policy_document=policy_document))\nprint(conn_iam.create_instance_profile(instance_profile_name))\nprint(conn_iam.add_role_to_instance_profile(instance_profile_name,\n                                            role_name))\n```\n\n## Trusted account instance\n\nTo create an ec2 instance that has the trusted account IAM role, launch the\n`opsec-security-auditor-cloudformation.json` cloudformation template in the\nOpSec controlled AWS account in which the `OpSecTrustedAuditor` IAM role and\n`OpSecTrustedAuditorInstanceProfile` instance profile were created in.\n","markers":{"markers":{"1":{"id":1,"range":[[0,0],[0,0]],"tailed":false,"reversed":false,"valid":true,"invalidate":"never","persistent":true,"properties":{"type":"selection","editorId":4},"deserializer":"Marker"}},"deserializer":"MarkerManager"},"history":{"undoStack":[],"redoStack":[],"deserializer":"History"},"encoding":"utf8","filePath":"/Users/lonnen/repos/security/operations/aws-security-auditor/README.md","modifiedWhenLastPersisted":false,"digestWhenLastPersisted":"c7d310bb7b56ef073bb0b5146162ba4310f92d15","deserializer":"TextBuffer"}],"deserializer":"Project"},"workspace":{"paneContainer":{"root":{"id":3,"items":[{"id":4,"softTabs":true,"displayBuffer":{"id":5,"softWrapped":true,"editorWidthInChars":null,"scrollTop":0,"scrollLeft":0,"tokenizedBuffer":{"bufferPath":"/Users/lonnen/repos/security/operations/aws-security-auditor/README.md","invisibles":null,"deserializer":"TokenizedBuffer"},"invisibles":null,"deserializer":"DisplayBuffer"},"deserializer":"TextEditor"}],"activeItemURI":"/Users/lonnen/repos/security/operations/aws-security-auditor/README.md","focused":false,"deserializer":"Pane"},"activePaneId":3,"deserializer":"PaneContainer","version":1},"fullScreen":false,"packagesWithActiveGrammars":["language-gfm","language-hyperlink","language-todo"],"deserializer":"Workspace"},"packageStates":{"command-logger":{"eventLog":{"editor:display-updated":{"count":7,"name":"editor:display-updated","lastRun":1426007315841},"pane:item-added":{"count":1,"name":"pane:item-added","lastRun":1426007315197},"pane-container:active-pane-item-changed":{"count":1,"name":"pane-container:active-pane-item-changed","lastRun":1426007315202},"editor:attached":{"count":1,"name":"editor:attached","lastRun":1426007315266},"pane:active-item-changed":{"count":1,"name":"pane:active-item-changed","lastRun":1426007315346}}},"fuzzy-finder":{"/Users/lonnen/repos/security/operations/aws-security-auditor/README.md":1426007315346},"metrics":{"sessionLength":10738563},"tree-view":{"directoryExpansionStates":{},"selectedPath":"/Users/lonnen/repos/security/operations/aws-security-auditor/README.md","hasFocus":true,"attached":true,"scrollLeft":0,"scrollTop":0,"width":200}}}